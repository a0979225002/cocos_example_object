
                (function() {
                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';
                    var __module = nodeEnv ? module : {exports:{}};
                    var __filename = 'preview-scripts/assets/scripts/ssr/fow/component/SSRFoWComponent.js';
                    var __require = nodeEnv ? function (request) {
                        return cc.require(request);
                    } : function (request) {
                        return __quick_compile_project__.require(request, __filename);
                    };
                    function __define (exports, require, module) {
                        if (!nodeEnv) {__quick_compile_project__.registerModule(__filename, module);}"use strict";
cc._RF.push(module, '8a216QSTKFAVo8loBP3b1AP', 'SSRFoWComponent');
// scripts/ssr/fow/component/SSRFoWComponent.js

"use strict";

/****************************************************************************
 Copyright (c) 2017-2020 SuperSuRaccoon
 
 Site: http://www.supersuraccoon-cocos2d.com
 Mail: supersuraccoon@gmail.com

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.
 ****************************************************************************/
var ssr = require('../namespace/SSRFoWNamespace');

var RevealStyle = cc.Enum({
  SQUARE: 1,
  DIAMOND: 2
});
var TileStyle = cc.Enum({
  RECT: 1,
  CIRCLE: 2
});
/**
 * ssr.FoW.Component 战雾组件
 * @class ssr.FoW.Component
 * @extends Component
 */

ssr.FoW.Component = cc.Class({
  "extends": cc.Component,
  editor: CC_EDITOR && {
    menu: 'ssr/FoW/Component'
  },
  properties: {
    /**
     * 用于渲染的 Graphics 对象，如果没有提供，会尝试使用 cc.Node 上 cc.Mask 对象的内置 Graphics 对象
     * @property {cc.Graphics} render
     * @default null
     */
    render: cc.Graphics,
    //
    _tileSize: 32,
    tileSize: {
      get: function get() {
        return this._tileSize;
      },
      set: function set(val) {
        this._tileSize = val;
      },
      tooltip: "单元 tile 的大小尺寸"
    },
    _range: 2,
    range: {
      get: function get() {
        return this._range;
      },
      set: function set(val) {
        this._range = val;
      },
      tooltip: "每次揭开迷雾的周边单元格范围"
    },
    _revealStyle: RevealStyle.DIAMOND,
    revealStyle: {
      type: RevealStyle,
      get: function get() {
        return this._revealStyle;
      },
      set: function set(val) {
        this._revealStyle = val;
      },
      tooltip: "揭开周围单元格的风格，支持钻石形状和矩形"
    },
    _tileStyle: TileStyle.CIRCLE,
    tileStyle: {
      type: TileStyle,
      get: function get() {
        return this._tileStyle;
      },
      set: function set(val) {
        this._tileStyle = val;
      },
      tooltip: "每个单元格的渲染风格，支持圆形和矩形"
    }
  },
  onLoad: function onLoad() {},
  start: function start() {
    if (!this.render) {
      this.mask = this.node.getComponent("cc.Mask");

      if (this.mask) {
        this.render = this.mask._graphics;
      }
    } //


    this.render.fillColor = cc.color(0, 0, 0, 255); //

    this._init();
  },
  _init: function _init() {
    /* 
        revealed tiles record array 
        null : unrevealed
        1    : revealed as centerCoord
        2    : revealed as aroundCoord
    */
    this._revealedTileArray = {};
  },
  _isTileRevealed: function _isTileRevealed(tileToReveal) {
    return tileToReveal.x in this._revealedTileArray && tileToReveal.y in this._revealedTileArray[tileToReveal.x] && (this._revealedTileArray[tileToReveal.x][tileToReveal.y] != ssr.TiledFogOfWarUtil.REVEAL_MARK.AROUND || this._revealedTileArray[tileToReveal.x][tileToReveal.y] != ssr.TiledFogOfWarUtil.REVEAL_MARK.CENTER);
  },
  _isTileRevealedAsCetner: function _isTileRevealedAsCetner(tileToReveal) {
    return tileToReveal.x in this._revealedTileArray && tileToReveal.y in this._revealedTileArray[tileToReveal.x] && this._revealedTileArray[tileToReveal.x][tileToReveal.y] == ssr.TiledFogOfWarUtil.REVEAL_MARK.CENTER;
  },
  _revealTile: function _revealTile(tileToReveal) {
    if (!this._revealedTileArray[tileToReveal.x]) {
      // this._revealedTileArray[tileToReveal.x] = [];
      this._revealedTileArray[tileToReveal.x] = {};
    }

    this._revealedTileArray[tileToReveal.x][tileToReveal.y] = ssr.TiledFogOfWarUtil.REVEAL_MARK.AROUND;
  },
  _revealTileAsCenter: function _revealTileAsCenter(tileToReveal) {
    if (!this._revealedTileArray[tileToReveal.x]) {
      // this._revealedTileArray[tileToReveal.x] = [];
      this._revealedTileArray[tileToReveal.x] = {};
    }

    this._revealedTileArray[tileToReveal.x][tileToReveal.y] = ssr.TiledFogOfWarUtil.REVEAL_MARK.CENTER;
  },
  updateFog: function updateFog(pos) {
    var centerCoord = ssr.TiledFogOfWarUtil.coordFromPos(pos, this.tileSize);

    if (this._isTileRevealedAsCetner(centerCoord)) {
      return;
    }

    if (this.revealStyle == ssr.TiledFogOfWarUtil.STYLE.SQUARE) {
      var tilesArray = ssr.TiledFogOfWarUtil.tilesAroundSquare(centerCoord, this.range);
    } else {
      var tilesArray = ssr.TiledFogOfWarUtil.tilesAroundDiamond(centerCoord, this.range);
    }

    var hasTilesToReveal = false;

    for (var i = 0; i < tilesArray.length; i++) {
      var tileToReveal = tilesArray[i];

      if (this._isTileRevealed(tileToReveal)) {
        if (centerCoord.equals(tileToReveal)) {
          // mark as centerCoord
          this._revealTileAsCenter(tileToReveal);
        }

        continue;
      }

      hasTilesToReveal = true;

      this._revealTile(tileToReveal);

      if (this.tileStyle == ssr.TiledFogOfWarUtil.RENDER_STYLE.RECT) {
        this.render.rect(tileToReveal.x * this.tileSize, tileToReveal.y * this.tileSize, this.tileSize, this.tileSize);
      } else if (this.tileStyle == ssr.TiledFogOfWarUtil.RENDER_STYLE.CIRCLE) {
        this.render.circle(tileToReveal.x * this.tileSize, tileToReveal.y * this.tileSize, this.tileSize);
      }
    }

    if (hasTilesToReveal) {
      this.render.fill();
    }
  },
  reset: function reset() {
    this.render.clear();
    this._revealedTileArray = {};
  }
});

cc._RF.pop();
                    }
                    if (nodeEnv) {
                        __define(__module.exports, __require, __module);
                    }
                    else {
                        __quick_compile_project__.registerModuleFunc(__filename, function () {
                            __define(__module.exports, __require, __module);
                        });
                    }
                })();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFzc2V0c1xcc2NyaXB0c1xcc3NyXFxmb3dcXGNvbXBvbmVudFxcU1NSRm9XQ29tcG9uZW50LmpzIl0sIm5hbWVzIjpbInNzciIsInJlcXVpcmUiLCJSZXZlYWxTdHlsZSIsImNjIiwiRW51bSIsIlNRVUFSRSIsIkRJQU1PTkQiLCJUaWxlU3R5bGUiLCJSRUNUIiwiQ0lSQ0xFIiwiRm9XIiwiQ29tcG9uZW50IiwiQ2xhc3MiLCJlZGl0b3IiLCJDQ19FRElUT1IiLCJtZW51IiwicHJvcGVydGllcyIsInJlbmRlciIsIkdyYXBoaWNzIiwiX3RpbGVTaXplIiwidGlsZVNpemUiLCJnZXQiLCJzZXQiLCJ2YWwiLCJ0b29sdGlwIiwiX3JhbmdlIiwicmFuZ2UiLCJfcmV2ZWFsU3R5bGUiLCJyZXZlYWxTdHlsZSIsInR5cGUiLCJfdGlsZVN0eWxlIiwidGlsZVN0eWxlIiwib25Mb2FkIiwic3RhcnQiLCJtYXNrIiwibm9kZSIsImdldENvbXBvbmVudCIsIl9ncmFwaGljcyIsImZpbGxDb2xvciIsImNvbG9yIiwiX2luaXQiLCJfcmV2ZWFsZWRUaWxlQXJyYXkiLCJfaXNUaWxlUmV2ZWFsZWQiLCJ0aWxlVG9SZXZlYWwiLCJ4IiwieSIsIlRpbGVkRm9nT2ZXYXJVdGlsIiwiUkVWRUFMX01BUksiLCJBUk9VTkQiLCJDRU5URVIiLCJfaXNUaWxlUmV2ZWFsZWRBc0NldG5lciIsIl9yZXZlYWxUaWxlIiwiX3JldmVhbFRpbGVBc0NlbnRlciIsInVwZGF0ZUZvZyIsInBvcyIsImNlbnRlckNvb3JkIiwiY29vcmRGcm9tUG9zIiwiU1RZTEUiLCJ0aWxlc0FycmF5IiwidGlsZXNBcm91bmRTcXVhcmUiLCJ0aWxlc0Fyb3VuZERpYW1vbmQiLCJoYXNUaWxlc1RvUmV2ZWFsIiwiaSIsImxlbmd0aCIsImVxdWFscyIsIlJFTkRFUl9TVFlMRSIsInJlY3QiLCJjaXJjbGUiLCJmaWxsIiwicmVzZXQiLCJjbGVhciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTtB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R0FBRyxDQUFDOEMsaUJBQUosQ0FBc0JtQixZQUF0QixDQUFtQ3hELE1BQXpELEVBQWlFO0FBQ2xFLGFBQUtRLE1BQUwsQ0FBWWtELE1BQVosQ0FDSXhCLFlBQVksQ0FBQ0MsQ0FBYixHQUFpQixLQUFLeEIsUUFEMUIsRUFFSXVCLFlBQVksQ0FBQ0UsQ0FBYixHQUFpQixLQUFLekIsUUFGMUIsRUFHSSxLQUFLQSxRQUhUO0FBTUg7QUFDSjs7QUFDRCxRQUFJeUMsZ0JBQUosRUFBc0I7QUFDbEIsV0FBSzVDLE1BQUwsQ0FBWW1ELElBQVo7QUFDSDtBQUNKLEdBM0p3QjtBQTRKekJDLEVBQUFBLEtBNUp5QixtQkE0SmhCO0FBQ0wsU0FBS3BELE1BQUwsQ0FBWXFELEtBQVo7QUFDQSxTQUFLN0Isa0JBQUwsR0FBMEIsRUFBMUI7QUFDSDtBQS9Kd0IsQ0FBVCxDQUFwQiIsInNvdXJjZVJvb3QiOiIvIiwic291cmNlc0NvbnRlbnQiOlsiLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiBDb3B5cmlnaHQgKGMpIDIwMTctMjAyMCBTdXBlclN1UmFjY29vblxuIFxuIFNpdGU6IGh0dHA6Ly93d3cuc3VwZXJzdXJhY2Nvb24tY29jb3MyZC5jb21cbiBNYWlsOiBzdXBlcnN1cmFjY29vbkBnbWFpbC5jb21cblxuIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuXG4gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW5cbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cblxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4gVEhFIFNPRlRXQVJFLlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5cbmNvbnN0IHNzciA9IHJlcXVpcmUoJy4uL25hbWVzcGFjZS9TU1JGb1dOYW1lc3BhY2UnKTtcblxubGV0IFJldmVhbFN0eWxlID0gY2MuRW51bSh7XG4gICAgU1FVQVJFICAgICAgICA6IDEsXG4gICAgRElBTU9ORCAgICAgICA6IDJcbn0pO1xuXG5sZXQgVGlsZVN0eWxlID0gY2MuRW51bSh7XG4gICAgUkVDVCAgICAgICAgICA6IDEsXG4gICAgQ0lSQ0xFICAgICAgICA6IDIsXG59KTtcblxuLyoqXG4gKiBzc3IuRm9XLkNvbXBvbmVudCDmiJjpm77nu4Tku7ZcbiAqIEBjbGFzcyBzc3IuRm9XLkNvbXBvbmVudFxuICogQGV4dGVuZHMgQ29tcG9uZW50XG4gKi9cbnNzci5Gb1cuQ29tcG9uZW50ID0gY2MuQ2xhc3Moe1xuICAgIGV4dGVuZHM6IGNjLkNvbXBvbmVudCxcbiAgICBlZGl0b3I6IENDX0VESVRPUiAmJiB7XG4gICAgICAgIG1lbnU6ICdzc3IvRm9XL0NvbXBvbmVudCdcbiAgICB9LFxuICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIOeUqOS6jua4suafk+eahCBHcmFwaGljcyDlr7nosaHvvIzlpoLmnpzmsqHmnInmj5DkvpvvvIzkvJrlsJ3or5Xkvb/nlKggY2MuTm9kZSDkuIogY2MuTWFzayDlr7nosaHnmoTlhoXnva4gR3JhcGhpY3Mg5a+56LGhXG4gICAgICAgICAqIEBwcm9wZXJ0eSB7Y2MuR3JhcGhpY3N9IHJlbmRlclxuICAgICAgICAgKiBAZGVmYXVsdCBudWxsXG4gICAgICAgICAqL1xuICAgICAgICByZW5kZXI6IGNjLkdyYXBoaWNzLFxuICAgICAgICAvL1xuICAgICAgICBfdGlsZVNpemU6IDMyLFxuICAgICAgICB0aWxlU2l6ZToge1xuICAgICAgICAgICAgZ2V0ICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fdGlsZVNpemU7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2V0ICh2YWwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl90aWxlU2l6ZSA9IHZhbDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0b29sdGlwOiBcIuWNleWFgyB0aWxlIOeahOWkp+Wwj+WwuuWvuFwiXG4gICAgICAgIH0sXG4gICAgICAgIF9yYW5nZTogMixcbiAgICAgICAgcmFuZ2U6IHtcbiAgICAgICAgICAgIGdldCAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JhbmdlO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldCAodmFsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcmFuZ2UgPSB2YWw7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdG9vbHRpcDogXCLmr4/mrKHmj63lvIDov7fpm77nmoTlkajovrnljZXlhYPmoLzojIPlm7RcIlxuICAgICAgICB9LFxuICAgICAgICBfcmV2ZWFsU3R5bGU6IFJldmVhbFN0eWxlLkRJQU1PTkQsXG4gICAgICAgIHJldmVhbFN0eWxlOiB7XG4gICAgICAgICAgICB0eXBlOiBSZXZlYWxTdHlsZSxcbiAgICAgICAgICAgIGdldCAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JldmVhbFN0eWxlO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldCAodmFsKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcmV2ZWFsU3R5bGUgPSB2YWw7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdG9vbHRpcDogXCLmj63lvIDlkajlm7TljZXlhYPmoLznmoTpo47moLzvvIzmlK/mjIHpkrvnn7PlvaLnirblkoznn6nlvaJcIlxuICAgICAgICB9LFxuICAgICAgICBfdGlsZVN0eWxlOiBUaWxlU3R5bGUuQ0lSQ0xFLFxuICAgICAgICB0aWxlU3R5bGU6IHtcbiAgICAgICAgICAgIHR5cGU6IFRpbGVTdHlsZSxcbiAgICAgICAgICAgIGdldCAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RpbGVTdHlsZTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXQgKHZhbCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3RpbGVTdHlsZSA9IHZhbDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0b29sdGlwOiBcIuavj+S4quWNleWFg+agvOeahOa4suafk+mjjuagvO+8jOaUr+aMgeWchuW9ouWSjOefqeW9olwiXG4gICAgICAgIH0sXG4gICAgfSxcbiAgICBvbkxvYWQgKCkge1xuICAgIH0sXG4gICAgc3RhcnQgKCkge1xuICAgICAgICBpZiAoIXRoaXMucmVuZGVyKSB7XG4gICAgICAgICAgICB0aGlzLm1hc2sgPSB0aGlzLm5vZGUuZ2V0Q29tcG9uZW50KFwiY2MuTWFza1wiKTtcbiAgICAgICAgICAgIGlmICh0aGlzLm1hc2spIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlciA9IHRoaXMubWFzay5fZ3JhcGhpY3M7ICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvL1xuICAgICAgICB0aGlzLnJlbmRlci5maWxsQ29sb3IgPSBjYy5jb2xvcigwLCAwLCAwLCAyNTUpO1xuICAgICAgICAvL1xuICAgICAgICB0aGlzLl9pbml0KCk7XG4gICAgfSxcbiAgICBfaW5pdCAoKSB7XG4gICAgICAgIC8qIFxuICAgICAgICAgICAgcmV2ZWFsZWQgdGlsZXMgcmVjb3JkIGFycmF5IFxuICAgICAgICAgICAgbnVsbCA6IHVucmV2ZWFsZWRcbiAgICAgICAgICAgIDEgICAgOiByZXZlYWxlZCBhcyBjZW50ZXJDb29yZFxuICAgICAgICAgICAgMiAgICA6IHJldmVhbGVkIGFzIGFyb3VuZENvb3JkXG4gICAgICAgICovXG4gICAgICAgIHRoaXMuX3JldmVhbGVkVGlsZUFycmF5ID0ge307XG4gICAgfSxcbiAgICBfaXNUaWxlUmV2ZWFsZWQgKHRpbGVUb1JldmVhbCkge1xuICAgICAgICByZXR1cm4gKHRpbGVUb1JldmVhbC54IGluIHRoaXMuX3JldmVhbGVkVGlsZUFycmF5ICYmXG4gICAgICAgICAgICAgICAgdGlsZVRvUmV2ZWFsLnkgaW4gdGhpcy5fcmV2ZWFsZWRUaWxlQXJyYXlbdGlsZVRvUmV2ZWFsLnhdICYmXG4gICAgICAgICAgICAgICAgKHRoaXMuX3JldmVhbGVkVGlsZUFycmF5W3RpbGVUb1JldmVhbC54XVt0aWxlVG9SZXZlYWwueV0gIT0gc3NyLlRpbGVkRm9nT2ZXYXJVdGlsLlJFVkVBTF9NQVJLLkFST1VORCB8fFxuICAgICAgICAgICAgICAgICB0aGlzLl9yZXZlYWxlZFRpbGVBcnJheVt0aWxlVG9SZXZlYWwueF1bdGlsZVRvUmV2ZWFsLnldICE9IHNzci5UaWxlZEZvZ09mV2FyVXRpbC5SRVZFQUxfTUFSSy5DRU5URVIpKTtcbiAgICB9LFxuICAgIF9pc1RpbGVSZXZlYWxlZEFzQ2V0bmVyICh0aWxlVG9SZXZlYWwpIHtcbiAgICAgICAgcmV0dXJuICh0aWxlVG9SZXZlYWwueCBpbiB0aGlzLl9yZXZlYWxlZFRpbGVBcnJheSAmJlxuICAgICAgICAgICAgICAgIHRpbGVUb1JldmVhbC55IGluIHRoaXMuX3JldmVhbGVkVGlsZUFycmF5W3RpbGVUb1JldmVhbC54XSAmJlxuICAgICAgICAgICAgICAgIHRoaXMuX3JldmVhbGVkVGlsZUFycmF5W3RpbGVUb1JldmVhbC54XVt0aWxlVG9SZXZlYWwueV0gPT0gc3NyLlRpbGVkRm9nT2ZXYXJVdGlsLlJFVkVBTF9NQVJLLkNFTlRFUik7XG4gICAgfSxcbiAgICBfcmV2ZWFsVGlsZSAodGlsZVRvUmV2ZWFsKSB7XG4gICAgICAgIGlmICghdGhpcy5fcmV2ZWFsZWRUaWxlQXJyYXlbdGlsZVRvUmV2ZWFsLnhdKSB7XG4gICAgICAgICAgICAvLyB0aGlzLl9yZXZlYWxlZFRpbGVBcnJheVt0aWxlVG9SZXZlYWwueF0gPSBbXTtcbiAgICAgICAgICAgIHRoaXMuX3JldmVhbGVkVGlsZUFycmF5W3RpbGVUb1JldmVhbC54XSA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3JldmVhbGVkVGlsZUFycmF5W3RpbGVUb1JldmVhbC54XVt0aWxlVG9SZXZlYWwueV0gPSBzc3IuVGlsZWRGb2dPZldhclV0aWwuUkVWRUFMX01BUksuQVJPVU5EO1xuICAgIH0sXG4gICAgX3JldmVhbFRpbGVBc0NlbnRlciAodGlsZVRvUmV2ZWFsKSB7XG4gICAgICAgIGlmICghdGhpcy5fcmV2ZWFsZWRUaWxlQXJyYXlbdGlsZVRvUmV2ZWFsLnhdKSB7XG4gICAgICAgICAgICAvLyB0aGlzLl9yZXZlYWxlZFRpbGVBcnJheVt0aWxlVG9SZXZlYWwueF0gPSBbXTtcbiAgICAgICAgICAgIHRoaXMuX3JldmVhbGVkVGlsZUFycmF5W3RpbGVUb1JldmVhbC54XSA9IHt9O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3JldmVhbGVkVGlsZUFycmF5W3RpbGVUb1JldmVhbC54XVt0aWxlVG9SZXZlYWwueV0gPSBzc3IuVGlsZWRGb2dPZldhclV0aWwuUkVWRUFMX01BUksuQ0VOVEVSO1xuICAgIH0sXG4gICAgdXBkYXRlRm9nIChwb3MpIHtcbiAgICAgICAgbGV0IGNlbnRlckNvb3JkID0gc3NyLlRpbGVkRm9nT2ZXYXJVdGlsLmNvb3JkRnJvbVBvcyhwb3MsIHRoaXMudGlsZVNpemUpO1xuICAgICAgICBpZiAodGhpcy5faXNUaWxlUmV2ZWFsZWRBc0NldG5lcihjZW50ZXJDb29yZCkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5yZXZlYWxTdHlsZSA9PSBzc3IuVGlsZWRGb2dPZldhclV0aWwuU1RZTEUuU1FVQVJFKSB7XG4gICAgICAgICAgICB2YXIgdGlsZXNBcnJheSA9IHNzci5UaWxlZEZvZ09mV2FyVXRpbC50aWxlc0Fyb3VuZFNxdWFyZShcbiAgICAgICAgICAgICAgICBjZW50ZXJDb29yZCwgXG4gICAgICAgICAgICAgICAgdGhpcy5yYW5nZVxuICAgICAgICAgICAgKTsgICAgXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB2YXIgdGlsZXNBcnJheSA9IHNzci5UaWxlZEZvZ09mV2FyVXRpbC50aWxlc0Fyb3VuZERpYW1vbmQoXG4gICAgICAgICAgICAgICAgY2VudGVyQ29vcmQsIFxuICAgICAgICAgICAgICAgIHRoaXMucmFuZ2VcbiAgICAgICAgICAgICk7ICAgXG4gICAgICAgIH1cbiAgICAgICAgdmFyIGhhc1RpbGVzVG9SZXZlYWwgPSBmYWxzZTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aWxlc0FycmF5Lmxlbmd0aDsgaSArKykge1xuICAgICAgICAgICAgdmFyIHRpbGVUb1JldmVhbCA9IHRpbGVzQXJyYXlbaV07XG4gICAgICAgICAgICBpZiAodGhpcy5faXNUaWxlUmV2ZWFsZWQodGlsZVRvUmV2ZWFsKSkge1xuICAgICAgICAgICAgICAgIGlmIChjZW50ZXJDb29yZC5lcXVhbHModGlsZVRvUmV2ZWFsKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBtYXJrIGFzIGNlbnRlckNvb3JkXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3JldmVhbFRpbGVBc0NlbnRlcih0aWxlVG9SZXZlYWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGhhc1RpbGVzVG9SZXZlYWwgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5fcmV2ZWFsVGlsZSh0aWxlVG9SZXZlYWwpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy50aWxlU3R5bGUgPT0gc3NyLlRpbGVkRm9nT2ZXYXJVdGlsLlJFTkRFUl9TVFlMRS5SRUNUKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVjdChcbiAgICAgICAgICAgICAgICAgICAgdGlsZVRvUmV2ZWFsLnggKiB0aGlzLnRpbGVTaXplLFxuICAgICAgICAgICAgICAgICAgICB0aWxlVG9SZXZlYWwueSAqIHRoaXMudGlsZVNpemUsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGlsZVNpemUsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGlsZVNpemVcblxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICh0aGlzLnRpbGVTdHlsZSA9PSBzc3IuVGlsZWRGb2dPZldhclV0aWwuUkVOREVSX1NUWUxFLkNJUkNMRSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLmNpcmNsZShcbiAgICAgICAgICAgICAgICAgICAgdGlsZVRvUmV2ZWFsLnggKiB0aGlzLnRpbGVTaXplLFxuICAgICAgICAgICAgICAgICAgICB0aWxlVG9SZXZlYWwueSAqIHRoaXMudGlsZVNpemUsXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGlsZVNpemVcblxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGhhc1RpbGVzVG9SZXZlYWwpIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLmZpbGwoKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgcmVzZXQgKCkge1xuICAgICAgICB0aGlzLnJlbmRlci5jbGVhcigpO1xuICAgICAgICB0aGlzLl9yZXZlYWxlZFRpbGVBcnJheSA9IHt9O1xuICAgIH1cbn0pO1xuXG4iXX0=