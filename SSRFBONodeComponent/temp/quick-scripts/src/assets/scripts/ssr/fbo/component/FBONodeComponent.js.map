{"version":3,"sources":["assets\\scripts\\ssr\\fbo\\component\\FBONodeComponent.js"],"names":["ssr","require","UpdateMode","cc","Enum","ONCE","ALWAYS","FBO","Component","Core","Class","properties","preview","editorOnly","notify","CC_EDITOR","updateFBO","tooltip","_flipY","flipY","get","set","val","_fboSprite","spriteFrame","setFlipY","group","_updateMode","updateMode","type","_backgroundColor","color","backgroundColor","value","_fboCamera","_initData","_isPaused","_initFBORenderTexture","_renderTexture","RenderTexture","_initFBOSprite","node","getComponent","Sprite","addComponent","fboSpriteFrame","SpriteFrame","_initFBOCamera","Camera","depth","clearFlags","ClearFlags","COLOR","targetTexture","enabled","onLoad","start","_updateRenderTextureSize","width","height","window","jsb","destroy","initWithSize","gfx","RB_FMT_S8","updateSize","update","render","target","setTexture","pause","resume"],"mappings":"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","sourceRoot":"/","sourcesContent":["/****************************************************************************\n Copyright (c) 2017-2020 SuperSuRaccoon\n \n Site: http://www.supersuraccoon-cocos2d.com\n Mail: supersuraccoon@gmail.com\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n \nconst ssr = require(\"../namespace/FBONamespace\");\n\n/**\n * FBO 更新模式枚举变量\n * @enum FBONodeComponent._updateMode\n * @static\n * @private\n * @namespace FBONodeComponent\n */\nlet UpdateMode = cc.Enum({\n\t/**\n     * 近更新一次\n     * @property {Number} ONCE\n     * @static\n     */\n    ONCE \t\t: 0,\n    /**\n     * 同步更新\n     * @property {Number} ONCE\n     * @static\n     */\n    ALWAYS\t\t: 1\n});\n\n/**\n * FBONodeComponent 组件基类，用于\n * @class FBONodeComponent\n * @extends Component\n */\nssr.FBO.Component.Core = cc.Class({\n    extends: cc.Component,\n    properties: {\n    \t/**\n\t     * 在编辑器模式下开启实时刷新预览\n\t     * @property {Boolean} preview\n\t     * @default true\n\t     */\n    \tpreview: {\n\t        default: true,\n\t        editorOnly: true,\n\t        notify: CC_EDITOR && function () {\n\t            if (this.preview) {\n\t            \tthis.updateFBO();\n\t            }\n\t        },\n\t        tooltip: \"是否在在编辑器中预览\"\n\t    },\n\t    /**\n\t     * 是否需要翻转纹理\n\t     * @property {Boolean} flipY\n\t     * @default true\n\t     */\n\t     _flipY: true,\n\t\tflipY: {\n\t\t\tget () {\n\t\t\t\treturn this._flipY;\n\t\t\t},\n\t\t\tset (val) {\n\t\t\t\tthis._flipY = val;\n                if (this._fboSprite && this._fboSprite.spriteFrame) {\n                    this._fboSprite.spriteFrame.setFlipY(val);\n                }\n\t\t\t\t// this.node.scaleY *= -1;\n\t\t\t},\n\t\t\ttooltip: \"是否需要翻转纹理\"\n\t\t},\n\t\t/**\n\t     * FBO 对象默认所属节点的分组。同 cc.Node 的 group 属性\n\t     * @property {String} group\n\t     * @default fbo\n\t     */\n\t\tgroup: {\n\t\t    default: \"fbo\",\n\t\t    tooltip: \"FBO 节点专用的分组名称\"\n\t\t},\n\t\t_updateMode: UpdateMode.ALWAYS,\n\t\t/**\n\t     * FBO 对象默认的更新模式\n\t     * @property {UpdateMode} updateMode\n\t     * @default UpdateMode.ALWAYS\n\t     */\n\t\tupdateMode: {\n\t\t    type: UpdateMode,\n\t\t    get () {\n\t\t        return this._updateMode;\n\t\t    },\n\t\t    set (val) {\n\t\t        this._updateMode = val;\n\t\t    },\n\t\t    tooltip: \"更新模式，默认实时更新\"\n\t\t},\n\t\t/**\n         * 摄像机用于清除屏幕的背景色。\n         * @property {Color} backgroundColor\n         */\n\t\t_backgroundColor: cc.color(0, 0, 0, 0),\n\t\tbackgroundColor: {\n            get () {\n                return this._backgroundColor;\n            },\n            set (value) {\n                this._backgroundColor.set(value);\n                this._fboCamera.backgroundColor = value;\n            },\n            tooltip: \"摄像机用于清除屏幕的背景色\",\n        },\n    },\n    /**\n     * 初始化内部数据\n     * @method _initData\n     * @private\n     */\n    _initData () {\n    \tthis._isPaused = false;\n    },\n    /**\n     * 初始化 RenderTexture 对象\n     * @method _initFBORenderTexture\n     * @private\n     */\n\t_initFBORenderTexture () {\n\t\tif (!this._renderTexture) {\n\t\t\tthis._renderTexture = new cc.RenderTexture();\n\t\t}\n\t},\n\t/**\n     * 初始化 FBO 最终渲染目标对象 cc.Sprite\n     * @method _initFBOSprite\n     * @private\n     */\n\t_initFBOSprite () {\n\t\tthis._fboSprite = this.node.getComponent(cc.Sprite);\n\t\tif (!this._fboSprite) {\n\t\t\tthis._fboSprite = this.node.addComponent(cc.Sprite);\n\t\t}\n\t\tif (!this._fboSprite.spriteFrame) {\n\t\t\tvar fboSpriteFrame = new cc.SpriteFrame();\n\t\t    this._fboSprite.spriteFrame = fboSpriteFrame;\n            this._fboSprite.spriteFrame.setFlipY(this.flipY);\n\t\t}\n\n\t\t// this.node.scaleY = this.flipY ? -1 : 1;\n\t},\n\t/**\n     * 初始化 FBO 专用 cc.Camera\n     * @method _initFBOCamera\n     * @private\n     */\n\t_initFBOCamera () {\n\t\tthis._fboCamera = this.node.getComponent(cc.Camera);\n\t\tif (!this._fboCamera) {\n\t\t\tthis._fboCamera = this.node.addComponent(cc.Camera);\n\t\t}\n\t\tthis._fboCamera.depth = 0;\n\t\tthis._fboCamera.clearFlags = cc.Camera.ClearFlags.COLOR;\n\t\tthis._fboCamera.backgroundColor = this.backgroundColor;\n\t\tthis._fboCamera.targetTexture = this._renderTexture;\n\t\tthis._fboCamera.enabled = false;\n\t},\n    /**\n     * onLoad 生命周期函数，将本 cc.Node 的 group 切换为用户指定的分组\n     * @method onLoad\n     */\n\tonLoad () {\n\t\tthis.node.group = this.group;\n\t},\n\t/**\n     * start 生命周期函数，初始化一些内部用对象，调用一次更新 FBO 函数 (UpdateMode.ONCE 模式仅此一次调用)\n     * @method start\n     */\n    start () {\n    \tthis._initData();\n     \tthis._initFBORenderTexture();\n     \tthis._initFBOSprite();\n     \tthis._initFBOCamera();\n     \tthis.updateFBO();\n    },\n    /**\n     * 更新 RenderTexture 大小\n     * @method _updateRenderTextureSize\n     * @private\n     */\n    _updateRenderTextureSize(width, height) {\n    \tif (!this._renderTexture) {\n\t\t\treturn;\n    \t}\n    \tif (window.jsb) {\n    \t\t// https://forum.cocos.org/t/cc-rendertexture-updatesize/99634\n    \t\tthis._renderTexture.destroy();\n    \t\tthis._renderTexture = new cc.RenderTexture();\n    \t\tthis._renderTexture.initWithSize(width, height, cc.gfx.RB_FMT_S8);\t\n    \t}\n    \telse {\n    \t\tthis._renderTexture.updateSize(width, height);\n    \t}\n    },\n    /**\n     * update 生命周期函数，每帧调用，更新 FBO (UpdateMode.ALWAYS 模式每帧调用)\n     * @method update\n     */\n    update () {\n    \tif (CC_EDITOR && !this.preview) {\n            return;\n        }\n        if (this._isPaused) {\n        \treturn;\n        }\n    \tif (this.updateMode == UpdateMode.ALWAYS) {\n    \t\tthis.updateFBO();\n    \t}\n    },\n    /**\n     * 刷新一次 FBO 并将其渲染到 cc.Sprite 对象中\n     * @method updateFBO\n     */\n\tupdateFBO () {\n\t\tif (CC_EDITOR && !this.preview) {\n            return;\n        }\n\t\tthis._fboCamera.enabled = true;\n\t\tthis._fboCamera.render(this.target);\n\t\tthis._fboSprite.spriteFrame.setTexture(this._renderTexture);\n\t\tthis._fboCamera.enabled = false;\n\t},\n\t/**\n     * 暂停刷新\n     * @method pause\n     */\n    pause () {\n    \tthis._isPaused = true;\n    },\n    /**\n     * 继续刷新\n     * @method resume\n     */\n    resume () {\n    \tthis._isPaused = false;\n    }\n});\n"]}