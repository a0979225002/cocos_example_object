{"version":3,"sources":["assets\\scripts\\ssr\\fbo\\component\\FBONodeCloneComponent.js"],"names":["ssr","require","FBO","Component","Clone","cc","Class","editor","CC_EDITOR","menu","executeInEditMode","properties","_target","target","type","Node","get","set","val","updateTarget","node","width","height","tooltip","_syncAngle","syncAngle","_syncScale","syncScale","_offsetX","offsetX","Float","_offsetY","offsetY","onEnable","_registerNodeEvent","on","_updateSize","_unregisterNodeEvent","off","_updateRenderTextureSize","_fboCamera","targetTexture","_renderTexture","orthoSize","_targetGroupOld","group","_targetAngleOld","_targetScaleXOld","_targetScaleYOld","_targetWidthOld","_targetHeightOld","position","v3","x","scaleX","y","scaleY","_initFBORenderTexture","_super","initWithSize","gfx","RB_FMT_S8","_initFBOCamera","cullingMask","groupIndex","alignWithScreen","updateFBO","oldPosition","angle","Camera","main","__preload","Flags","Object","_objFlags","IsScaleLocked","IsAnchorLocked","IsPositionLocked","onLoad","onDisable"],"mappings":"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","sourceRoot":"/","sourcesContent":["/****************************************************************************\n Copyright (c) 2017-2020 SuperSuRaccoon\n \n Site: http://www.supersuraccoon-cocos2d.com\n Mail: supersuraccoon@gmail.com\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in\n all copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n THE SOFTWARE.\n ****************************************************************************/\n \nconst ssr = require(\"../namespace/FBONamespace\");\n\n/**\n * 指定[区域纹理] 的FBO 专用类\n * @class FBONodeRegionComponent\n * @extends FBONodeComponent\n * 主相机      everything &= ~(1 << fbo);\n * 目标对象    fbo\n * fbo相机     nothing |= ~(1 << fbo);\n * fbo对象     clone\n */\nssr.FBO.Component.Clone = cc.Class({\n    extends: require(\"./FBONodeComponent.js\"),\n    editor: CC_EDITOR && {\n        menu: 'ssr/FBO/Clone',\n        executeInEditMode: true,\n    },\n    properties: {\n        _target: null,\n        target: {\n            type: cc.Node,\n            get () {\n                return this._target;\n            },\n            set (val) {\n                this._target = val;\n                this.updateTarget();\n                this.node.width = this._target.width;\n                this.node.height = this._target.height;\n            },\n            tooltip: \"FBO 目标节点\"\n        },\n        _syncAngle: false,\n        syncAngle: {\n            get () {\n                return this._syncAngle;\n            },\n            set (val) {\n                this._syncAngle = val;\n            },\n            tooltip: \"是否需要动态监测目标旋转角度\"\n        },\n        _syncScale: false,\n        syncScale: {\n            get () {\n                return this._syncScale;\n            },\n            set (val) {\n                this._syncScale = val;\n            },\n            tooltip: \"是否需要动态监测目标缩放大小\"\n        },\n        _offsetX: 0,\n        offsetX: {\n            type: cc.Float,\n            get () {\n                return this._offsetX;\n            },\n            set (val) {\n                this._offsetX = val;\n                this.updateTarget();\n            },\n            tooltip: \"FBO 渲染区域 X轴方向偏移量\"\n        },\n        _offsetY: 0,\n        offsetY: {\n            type: cc.Float,\n            get () {\n                return this._offsetY;\n            },\n            set (val) {\n                this._offsetY = val;\n                this.updateTarget();\n            }\n        }\n    },\n    onEnable () {\n        this._registerNodeEvent();\n    },\n    _registerNodeEvent () {\n        this.node.on('size-changed', this._updateSize, this);\n    },\n\n    _unregisterNodeEvent () {\n        this.node.off('size-changed', this._updateSize, this);\n    },\n    _updateSize () {\n        this._updateRenderTextureSize(this.node.width, this.node.height);\n        this._fboCamera.targetTexture = this._renderTexture;\n        this._fboCamera.orthoSize = this.node.height / 2;\n    },\n    updateTarget () {\n        if (!this.target) {\n            return;\n        }\n        this._targetGroupOld = this.target.group;\n        this._targetAngleOld = 0;\n        this._targetScaleXOld = 0;\n        this._targetScaleYOld = 0;\n        this._targetWidthOld = 0;\n        this._targetHeightOld = 0;\n\n        this.target.group = this.group;\n        this.node.position = cc.v3(this.target.x + this.offsetX * this.target.scaleX, this.target.y + this.offsetY * this.target.scaleY, 1);\n    },\n    /**\n     * 重写初始化 RenderTexture 对象，纹理大小为指定尺寸大小\n     * @method _initFBORenderTexture\n     * @private\n     */\n    _initFBORenderTexture () {\n        this._super();\n        this._renderTexture.initWithSize(this.node.width, this.node.height, cc.gfx.RB_FMT_S8);\n    },\n    /**\n     * 重写初始化 FBO 专用 cc.Camera , 设置 cullingMask，开启自定义大小模式\n     * @method _initFBOCamera\n     * @private\n     */\n    _initFBOCamera () {\n        this._super();\n        this._fboCamera.cullingMask = 0x00000000;\n        this._fboCamera.cullingMask |= ~(1 << this.node.groupIndex);\n\n        this._fboCamera.alignWithScreen = false;\n        this._fboCamera.orthoSize = this.node.height / 2;\n    },\n    /**\n     * 重写update 生命周期函数，渲染前后更新节点的坐标\n     * @method update\n     */\n    updateFBO () {\n        if (!this.target) {\n            return;\n        }\n        let oldPosition = this.node.position;\n        if (this.syncAngle && this._targetAngleOld != this.target.angle) {\n            this._targetAngleOld = this.target.angle;\n            this.node.angle = this.target.angle = 0;\n        }\n        if (this.syncScale) {\n            if (this._targetScaleXOld != this.target.scaleX) {\n                this._targetScaleXOld = this.target.scaleX;\n            }\n            if (this._targetScaleYOld != this.target.scaleY) {\n                this._targetScaleYOld = this.target.scaleY;\n            }\n            this.node.scaleX = this.target.scaleX = 1;\n            this.node.scaleY = this.target.scaleY = 1;\n        }\n\n        this.node.position = cc.v3(this.target.x + this.offsetX * this.target.scaleX, this.target.y + this.offsetY * this.target.scaleY, 1);\n        this._fboCamera.orthoSize = this.node.height / 2 * this.target.scaleX;\n        this._super();\n        this._fboCamera.orthoSize = this.node.height / 2;\n        cc.Camera.main.cullingMask &= ~(1 << this.target.groupIndex);\n        if (this.syncAngle) {\n            this.node.angle = this.target.angle = this._targetAngleOld;\n        }\n        if (this.syncScale) {\n            this.node.scaleX = this.target.scaleX = this._targetScaleXOld;\n            this.node.scaleY = this.target.scaleY = this._targetScaleYOld;  \n            // this.node.scaleY *= (this.flipY ? -1 : 1);\n        }\n        this.node.position = cc.v3(oldPosition.x, oldPosition.y, 1);\n    },\n    __preload () {\n        if (CC_EDITOR) {\n            var Flags = cc.Object.Flags;\n            this._objFlags |= (Flags.IsScaleLocked | Flags.IsAnchorLocked | Flags.IsPositionLocked);\n        }\n    },\n    onLoad () {\n        this._super();\n        //\n        this.node.group = \"clone\";\n        this.updateTarget();\n    },\n    onDisable() {\n        this._unregisterNodeEvent();\n        this.target.group = this._targetGroupOld;\n    }\n});\n"]}