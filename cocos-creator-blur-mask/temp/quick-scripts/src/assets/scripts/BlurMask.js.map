{"version":3,"sources":["assets\\scripts\\BlurMask.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["/**\r\n * 模糊节点控制器\r\n * @author wheatup\r\n * @version 1.0\r\n */\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class BlurMask extends cc.Component {\r\n\tcamera: cc.Camera = null;\r\n\ttexture: cc.RenderTexture = null;\r\n\tspriteFrame: cc.SpriteFrame = null;\r\n\tsprite: cc.Sprite = null;\r\n\r\n\t_lastSize = new cc.Size(0, 0);\r\n\t_cullingMask = 0x10000000;\r\n\r\n\t@property({\r\n\t\t// @ts-ignore\r\n\t\ttype: cc.Material,\r\n\t\tdisplayName: \"模糊材质\",\r\n\t\ttooltip: \"用于应用模糊所用的材质，如无特殊需求请保持默认\"\r\n\t})\r\n\tmaterial = null;\r\n\r\n\t@property({\r\n\t\ttype: [cc.Node],\r\n\t\tdisplayName: \"忽略节点列表\",\r\n\t\ttooltip: \"在此列表内的节点将不会被模糊遮罩渲染\"\r\n\t})\r\n\tignoredNodes = [];\r\n\r\n\t@property({\r\n\t\ttype: cc.Float,\r\n\t\tdisplayName: \"亮度\",\r\n\t\ttooltip: \"降低背景的亮度\",\r\n\t\tmin: 0,\r\n\t\tmax: 1\r\n\t})\r\n\tbightness: number = 0.5;\r\n\r\n\t@property({\r\n\t\ttype: cc.Float,\r\n\t\tdisplayName: \"模糊度\",\r\n\t\ttooltip: \"背景的模糊程度\",\r\n\t\tmin: 0,\r\n\t\tmax: 1\r\n\t})\r\n\tblurAmount: number = 0.5;\r\n\r\n\tstart() {\r\n\t\t// 截图图像是翻转的，所以y轴镜像\r\n\t\tthis.node.scaleY = -1;\r\n\r\n\t\t// 创建渲染贴图对象\r\n\t\tthis.texture = new cc.RenderTexture();\r\n\t\tthis.texture.initWithSize(this.node.width, this.node.height, cc.game['_renderContext']['STENCIL_INDEX8']);\r\n\r\n\t\t// 在node上创建摄影机\r\n\t\tthis.camera = this.node.addComponent(cc.Camera);\r\n\t\t// 不渲染0x10000000的cullingMask对象\r\n\t\tthis.camera.cullingMask = 0xffffffff ^ this._cullingMask;\r\n\t\tthis.camera.targetTexture = this.texture;\r\n\t\t// 关闭摄影机，否则每一帧它会自动进行渲染\r\n\t\tthis.camera.enabled = false;\r\n\r\n\t\t// 将自身与忽略对象排除渲染\r\n\t\tthis.cull(this.node);\r\n\t\tthis.ignoredNodes.map(node => this.cull(node));\r\n\r\n\t\t// 创建一个sprite组件，由其进行渲染\r\n\t\tthis.spriteFrame = new cc.SpriteFrame();\r\n\t\tthis.sprite = this.node.addComponent(cc.Sprite);\r\n\t\tthis.sprite.spriteFrame = this.spriteFrame;\r\n\t\tthis.material[\"_props\"][\"bightness\"] = this.bightness;\r\n\t\tthis.material[\"_props\"][\"blurAmount\"] = this.blurAmount;\r\n\t\tthis.sprite[\"_materials\"][0] = this.material;\r\n\t}\r\n\r\n\t// 截图并模糊\r\n\tsnapshot() {\r\n\t\tlet size = this.node.getContentSize();\r\n\t\tif (size.width !== this._lastSize.width || size.height !== this._lastSize.height) {\r\n\t\t\t// 大小发生改变，重新设置texture大小\r\n\t\t\tthis.texture.initWithSize(this.node.width, this.node.height, cc.game['_renderContext']['STENCIL_INDEX8']);\r\n\t\t\tthis.camera.targetTexture = this.texture;\r\n\t\t}\r\n\t\tthis._lastSize.width = size.width;\r\n\t\tthis._lastSize.height = size.height;\r\n\r\n\t\t// 手动渲染摄影机，保存截图\r\n\t\tthis.camera.render(cc.Canvas.instance.node);\r\n\r\n\t\t// 应用刚刚截图的贴图到sprite身上进行渲染\r\n\t\tthis.spriteFrame.setTexture(this.texture);\r\n\t}\r\n\r\n\tupdate(dt) {\r\n\t\t// 每一帧都进行截图处理，可以换成需要的时候再调用，比较省资源\r\n\t\tthis.snapshot();\r\n\t}\r\n\r\n\t// 排除忽略渲染对象及其子对象\r\n\tprivate cull(node: cc.Node) {\r\n\t\tif (node) {\r\n\t\t\tnode[\"_cullingMask\"] = this._cullingMask;\r\n\t\t\tif (node.childrenCount > 0) {\r\n\t\t\t\tnode.children.map(child => this.cull(child));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n"]}