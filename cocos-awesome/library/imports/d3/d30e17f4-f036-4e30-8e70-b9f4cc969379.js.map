{"version":3,"sources":["assets\\Scene\\Scratch_ticket\\Scratch_ticket.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const { ccclass, property } = cc._decorator;\r\nconst CALC_RECT_WIDTH = 40;\r\nconst CLEAR_LINE_WIDTH = 40;\r\n\r\n@ccclass\r\nexport default class Scratch_ticket extends cc.Component {\r\n  @property(cc.Node)\r\n  maskNode: cc.Node = null;\r\n  @property(cc.Node)\r\n  ticketNode: cc.Node = null;\r\n  @property(cc.Label)\r\n  progerss: cc.Label = null;\r\n\r\n  onLoad() {\r\n    this.reset();\r\n    this.ticketNode.on(cc.Node.EventType.TOUCH_START, this.touchStartEvent, this);\r\n    this.ticketNode.on(cc.Node.EventType.TOUCH_MOVE, this.touchMoveEvent, this);\r\n    this.ticketNode.on(cc.Node.EventType.TOUCH_END, this.touchEndEvent, this);\r\n    this.ticketNode.on(cc.Node.EventType.TOUCH_CANCEL, this.touchEndEvent, this);\r\n  }\r\n\r\n  beforeDestroy() {\r\n    this.ticketNode.off(cc.Node.EventType.TOUCH_START, this.touchStartEvent, this);\r\n    this.ticketNode.off(cc.Node.EventType.TOUCH_MOVE, this.touchMoveEvent, this);\r\n    this.ticketNode.off(cc.Node.EventType.TOUCH_END, this.touchEndEvent, this);\r\n    this.ticketNode.off(cc.Node.EventType.TOUCH_CANCEL, this.touchEndEvent, this);\r\n  }\r\n\r\n  touchStartEvent(event) {\r\n    let point = this.ticketNode.convertToNodeSpaceAR(event.getLocation());\r\n    this.clearMask(point);\r\n  }\r\n\r\n  touchMoveEvent(event) {\r\n    let point = this.ticketNode.convertToNodeSpaceAR(event.getLocation());\r\n    this.clearMask(point);\r\n  }\r\n\r\n  touchEndEvent() {\r\n    this.tempDrawPoints = [];\r\n    this.calcProgress();\r\n  }\r\n\r\n  calcDebugger: boolean = false; // 辅助开关，开启则会绘制划开涂层所属的小格子\r\n  calcProgress() {\r\n    let hitItemCount = 0;\r\n    let ctx = this.ticketNode.getComponent(cc.Graphics);\r\n    this.polygonPointsList.forEach((item) => {\r\n      if (!item.isHit) return;\r\n      hitItemCount += 1;\r\n\r\n      if (!this.calcDebugger) return;\r\n      ctx.rect(item.rect.x, item.rect.y, item.rect.width, item.rect.height);\r\n      ctx.fillColor = cc.color(216, 18, 18, 255);\r\n      ctx.fill();\r\n    });\r\n\r\n    this.progerss.string = `已经刮开了 ${Math.ceil((hitItemCount / this.polygonPointsList.length) * 100)}%`;\r\n  }\r\n\r\n  tempDrawPoints: cc.Vec2[] = [];\r\n  clearMask(pos) {\r\n    let mask: any = this.maskNode.getComponent(cc.Mask);\r\n    let stencil = mask._graphics;\r\n    const len = this.tempDrawPoints.length;\r\n    this.tempDrawPoints.push(pos);\r\n\r\n    if (len <= 1) {\r\n      // 只有一个点，用圆来清除涂层\r\n      stencil.circle(pos.x, pos.y, CLEAR_LINE_WIDTH / 2);\r\n      stencil.fill();\r\n\r\n      // 记录点所在的格子\r\n      this.polygonPointsList.forEach((item) => {\r\n        if (item.isHit) return;\r\n        const xFlag = pos.x > item.rect.x && pos.x < item.rect.x + item.rect.width;\r\n        const yFlag = pos.y > item.rect.y && pos.y < item.rect.y + item.rect.height;\r\n        if (xFlag && yFlag) item.isHit = true;\r\n      });\r\n    } else {\r\n      // 存在多个点，用线段来清除涂层\r\n      let prevPos = this.tempDrawPoints[len - 2];\r\n      let curPos = this.tempDrawPoints[len - 1];\r\n\r\n      stencil.moveTo(prevPos.x, prevPos.y);\r\n      stencil.lineTo(curPos.x, curPos.y);\r\n      stencil.lineWidth = CLEAR_LINE_WIDTH;\r\n      stencil.lineCap = cc.Graphics.LineCap.ROUND;\r\n      stencil.lineJoin = cc.Graphics.LineJoin.ROUND;\r\n      stencil.strokeColor = cc.color(255, 255, 255, 255);\r\n      stencil.stroke();\r\n\r\n      // 记录线段经过的格子\r\n      this.polygonPointsList.forEach((item) => {\r\n        item.isHit = item.isHit || cc.Intersection.lineRect(prevPos, curPos, item.rect);\r\n      });\r\n    }\r\n  }\r\n\r\n  polygonPointsList: { rect: cc.Rect; isHit: boolean }[] = [];\r\n  reset() {\r\n    let mask: any = this.maskNode.getComponent(cc.Mask);\r\n    mask._graphics.clear();\r\n\r\n    this.tempDrawPoints = [];\r\n    this.polygonPointsList = [];\r\n    this.progerss.string = '已经刮开了 0%';\r\n    this.ticketNode.getComponent(cc.Graphics).clear();\r\n\r\n    // 生成小格子，用来辅助统计涂层的刮开比例\r\n    for (let x = 0; x < this.ticketNode.width; x += CALC_RECT_WIDTH) {\r\n      for (let y = 0; y < this.ticketNode.height; y += CALC_RECT_WIDTH) {\r\n        this.polygonPointsList.push({\r\n          rect: cc.rect(x - this.ticketNode.width / 2, y - this.ticketNode.height / 2, CALC_RECT_WIDTH, CALC_RECT_WIDTH),\r\n          isHit: false\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n"]}